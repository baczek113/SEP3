@page "/applicant/applications"
@using WebApp.DTOs.Application
@using WebApp.DTOs.Job
@using WebApp.Services
@using System.Security.Claims

@inject HttpApplicationService AppService
@inject HttpJobListingService JobListingService
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav
@rendermode InteractiveServer

<div class="dash-shell">
    <div class="dash-card">
        <div class="dash-header">
            <div class="dash-title">
                <h2>My Applications</h2>
                <p>Track the status of jobs you've applied to.</p>
            </div>
            <a href="/applicant/dashboard" class="secondary-btn">
                ← Find Jobs
            </a>
        </div>

        <div class="dash-content">
            @if (_items == null)
            {
                <p class="dash-loading">Loading...</p>
            }
            else if (!_items.Any())
            {
                <div class="dash-empty">
                    <h4>No active applications</h4>
                    <p>Go to the Dashboard to swipe on some jobs!</p>
                </div>
            }
            else
            {
                <div class="job-list">
                    @foreach (var item in _items)
                    {
                        var app = item.Application;
                        var job = item.Job;

                        <div class="job-card">
                            <div class="job-card-header">
                                <h3>@job.Title</h3>

                              
                                @if (!string.IsNullOrWhiteSpace(job.City))
                                {
                                    <span class="job-location">@job.City</span>
                                }
                                
                                <span class="app-status-pill @GetStatusClass(app.Status)">
                                    @FormatStatus(app.Status)
                                </span>
                            </div>

                            
                            @if (job.Salary is not null)
                            {
                                <p class="job-salary">
                                    @($"{job.Salary:C0}")
                                </p>
                            }
                            
                            @if (!string.IsNullOrWhiteSpace(job.Description))
                            {
                                <p class="job-description">
                                    @job.Description
                                </p>
                            }

                            <div class="job-meta-row">
                                <span class="job-meta-pill">
                                    Applied @app.SubmittedAt.ToShortDateString()
                                </span>

                                @if (job.DatePosted != default)
                                {
                                    <span class="job-meta-pill subtle">
                                        Posted @job.DatePosted.ToShortDateString()
                                    </span>
                                }
                            </div>

                            <div class="application-actions">
                                @if (app.Status.Equals("MATCHED", StringComparison.OrdinalIgnoreCase))
                                {
                                    <a href="/chat/@job.Id/@_applicantId" class="primary-btn w-100">
                                        💬 Chat with Recruiter
                                    </a>
                                }
                                else if (app.Status.Equals("DECLINED", StringComparison.OrdinalIgnoreCase))
                                {
                                    <button disabled class="secondary-btn w-100">Declined</button>
                                }
                                else
                                {
                                    <button disabled class="secondary-btn w-100">Pending Review...</button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@code {
    private long _applicantId;

    
    private List<ApplicationWithJob>? _items;
    private class ApplicationWithJob
    {
        public ApplicationDto Application { get; set; } = default!;
        public JobListingDto Job { get; set; } = default!;
    }

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthState.GetAuthenticationStateAsync();
        var user = state.User;
        var idClaim = user.FindFirst(ClaimTypes.NameIdentifier);

        if (idClaim == null || !long.TryParse(idClaim.Value, out _applicantId))
        {
            _items = new();
            return;
        }

        var applications = await AppService.GetByApplicantAsync(_applicantId);

        if (applications == null || !applications.Any())
        {
            _items = new();
            return;
        }

        var list = new List<ApplicationWithJob>();

        foreach (var app in applications)
        {
            try
            {
               
                var job = await JobListingService.GetByIdAsync(app.JobId);

                if (job != null)
                {
                    list.Add(new ApplicationWithJob
                    {
                        Application = app,
                        Job = job
                    });
                }
            }
            catch
            { 
            }
        }

        _items = list;
    }

    private string GetStatusClass(string status) => status.ToUpper() switch
    {
        "MATCHED"  => "matched",
        "DECLINED" => "declined",
        _          => "pending"
    };

    private string FormatStatus(string status) => status.ToUpper() switch
    {
        "MATCHED"  => "Matched",
        "DECLINED" => "Declined",
        _          => "Under Review"
    };
}
