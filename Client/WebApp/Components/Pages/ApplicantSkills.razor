@page "/applicant/skills"
@using WebApp.DTOs.Applicant
@using Services
@inject HttpApplicantService HttpApplicantService
@layout AuthLayout
@page "/applicant/skills/{ApplicantId:long}"
@rendermode InteractiveServer

<div class="skills-page">
    <div class="skills-header">
        <div class="skills-title">
            <button type="button" class="add-skill-icon">
                +
            </button>
            <div class="skills-title-text">
                <h3>Add your skills</h3>
                <p>
                    Choose the skills that best describe you. 
                    The more accurate your profile, the easier it is to find the perfect match.
                </p>
            </div>
        </div>
    </div>

    @if (selectedSkills.Any())
    {
        <div class="selected-skills-section">
            <span class="selected-label">Selected skills:</span>
            <div class="selected-skills-chips">
                @foreach (var s in selectedSkills)
                {
                    <div class="selected-skill-item">
                        <button class="skill-chip selected"
                                type="button"
                                @onclick="() => ToggleSkill(s.Skill)">
                            @s.Skill.Name
                            <span class="chip-remove">×</span>
                        </button>

                        <select class="skill-level-select" @bind="s.Level">
                            @foreach (var lvl in levelOptions)
                            {
                                <option value="@lvl">@GetLevelLabel(lvl)</option>
                            }
                        </select>
                    </div>
                }
            </div>
        </div>
    }


    <div class="skills-grid">
        @foreach (var group in groupedSkills)
        {
            <div class="skill-category-card">
                <div class="skill-category-header">
                    <h4>@group.Key</h4>
                    <p>@GetCategoryDescription(group.Key)</p>
                </div>
                <div class="skills-list">
                    @foreach (var skill in group)
                    {
                        var isSelected = selectedSkills.Any(s => s.Skill.Name == skill.Name);

                        <button type="button"
                                class="skill-chip @(isSelected ? "selected" : "")"
                                @onclick="() => ToggleSkill(skill)">
                            @skill.Name
                        </button>
                    }

                </div>
            </div>
        }
    </div>

    <div class="skills-actions">
        <button class="save-skills-btn"
                @onclick="SaveSkills"
                disabled="@(!selectedSkills.Any() || isSaving)">
            @(isSaving ? "Saving..." : "Save skills")
        </button>
        <p class="hint-text">
            You can update your skills anytime to keep your profile fresh.
        </p>
    </div>

    <div class="@($"notification-container {(notificationVisible ? "show" : "")}")">
        <div class="@($"notification {notificationType}")">
            @notificationMessage
        </div>
    </div>
</div>


@code {
    
    [Parameter] 
    public long ApplicantId { get; set; }   


    private bool isSaving = false;

    private bool notificationVisible = false;
    private string notificationMessage = string.Empty;
    private string notificationType = string.Empty;
    
    private record SkillOption(string Name, string Category);

    
    private readonly List<SkillOption> allSkills = new()
    {
        new("C#",          "Backend"),
        new("Java",        "Backend"),
        new("Spring Boot", "Backend"),
        new(".NET",        "Backend"),
        new("SQL",         "Backend"),
        new("PostgreSQL",  "Backend"),

        new("JavaScript",  "Frontend"),
        new("TypeScript",  "Frontend"),
        new("React",       "Frontend"),
        new("Blazor",      "Frontend"),
        new("HTML/CSS",    "Frontend"),

        new("Docker",      "DevOps"),
        new("Kubernetes",  "DevOps"),
        new("CI/CD",       "DevOps"),
        new("Git",         "DevOps"),

        new("Problem solving", "Soft skills"),
        new("Teamwork",        "Soft skills"),
        new("Communication",   "Soft skills"),
        new("Leadership",      "Soft skills")
    };

    private ILookup<string, SkillOption> groupedSkills => allSkills.ToLookup(s => s.Category);

    private class SelectedSkill
    {
        public SkillOption Skill { get; set; } = default!;
        public SkillLevelDto Level { get; set; } = SkillLevelDto.Mid;
    }

    private List<SelectedSkill> selectedSkills = new();


    private readonly IReadOnlyList<SkillLevelDto> levelOptions =
        Enum.GetValues<SkillLevelDto>();


    private void ToggleSkill(SkillOption skill)
    {
        var existing = selectedSkills.FirstOrDefault(s => s.Skill.Name == skill.Name);

        if (existing is not null)
        {
            
            selectedSkills.Remove(existing);
        }
        else
        {
            
            selectedSkills.Add(new SelectedSkill
            {
                Skill = skill,
                Level = SkillLevelDto.Mid
            });
        }
    }


    private string GetCategoryDescription(string category) => category switch
    {
        "Backend"      => "Technologies and tools used to build APIs and server-side logic.",
        "Frontend"     => "Skills for building modern, interactive user interfaces.",
        "DevOps"       => "Tools and practices for deployment, monitoring and automation.",
        "Soft skills"  => "Human skills that make you a great teammate.",
        _              => "Skills that make you stand out."
    };
    private async Task SaveSkills()
    {
        if (!selectedSkills.Any())
            return;

        isSaving = true;
        try
        {
            foreach (var s in selectedSkills)
            {
                var dto = new AddApplicantSkillDto
                {
                    ApplicantId = ApplicantId,
                    SkillName   = s.Skill.Name,
                    Category    = s.Skill.Category,
                    Level       = s.Level
                };

                await HttpApplicantService.AddApplicantSkillAsync(dto);
            }

            ShowNotification("Skills have been saved to your profile.", "success");
        }
        catch (Exception ex)
        {
            ShowNotification($"Failed to save skills: {ex.Message}", "error");
        }
        finally
        {
            isSaving = false;
        }
    }

    
    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;
        notificationVisible = true;

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            notificationVisible = false;
            InvokeAsync(StateHasChanged);
        });
    }
    private string GetLevelLabel(SkillLevelDto level) => level switch
    {
        SkillLevelDto.Beginner => "Beginner",
        SkillLevelDto.Junior   => "Junior",
        SkillLevelDto.Mid      => "Mid",
        SkillLevelDto.Senior   => "Senior",
        SkillLevelDto.Expert   => "Expert",
        _                      => level.ToString()
    };

}
