@page "/register"
@layout AuthLayout
@using System.ComponentModel.DataAnnotations
@using WebApp.DTOs.Applicant
@using WebApp.DTOs.CompanyRepresentative
@inject HttpApplicantService HttpApplicantService
@inject HttpCompanyRepresentativeService HttpCompanyRepresentativeService
@rendermode InteractiveServer
@inject NavigationManager Nav
@using WebApp.DTOs.Applicant
@using WebApp.Services


<div class="register-shell">
    <div class="register-card">
        <div class="register-header">
            <h2>Create Your HireFire Account</h2>
            <p>
                Choose how you want to get started â€” as an applicant looking for your next challenge
                or as a company representative searching for the right talent.
            </p>

            <div class="register-switch">
                <button class="switch-btn @(currentMode == RegisterMode.Applicant ? "active" : "")"
                        @onclick="() => SetMode(RegisterMode.Applicant)">
                    Applicant
                </button>
                <button class="switch-btn @(currentMode == RegisterMode.Representative ? "active" : "")"
                        @onclick="() => SetMode(RegisterMode.Representative)">
                    Company Representative
                </button>
            </div>
        </div>

        <div class="register-form-area">
            @if (currentMode == RegisterMode.Applicant)
            {
                <EditForm Model="@applicantProfile" OnValidSubmit="HandleApplicantSubmit">
                    <DataAnnotationsValidator />

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="a-name">Full Name</label>
                            <InputText id="a-name" class="form-control" @bind-Value="applicantProfile.Name" />
                            <ValidationMessage For="@(() => applicantProfile.Name)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="a-email">Email</label>
                            <InputText id="a-email" class="form-control" @bind-Value="applicantProfile.Email" />
                            <ValidationMessage For="@(() => applicantProfile.Email)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="a-password">Password</label>
                            <InputText type="password" id="a-password" class="form-control" @bind-Value="applicantProfile.Password" />
                            <ValidationMessage For="@(() => applicantProfile.Password)" class="validation-message" />
                        </div>

                        <div class="form-group full-width">
                            <label for="a-experience">Experience</label>
                            <InputTextArea id="a-experience" class="form-control" @bind-Value="applicantProfile.Experience" />
                            <ValidationMessage For="@(() => applicantProfile.Experience)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="a-city">City</label>
                            <InputText id="a-city" class="form-control" @bind-Value="applicantProfile.City" />
                            <ValidationMessage For="@(() => applicantProfile.City)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="a-postcode">Postcode</label>
                            <InputText id="a-postcode" class="form-control" @bind-Value="applicantProfile.Postcode" />
                            <ValidationMessage For="@(() => applicantProfile.Postcode)" class="validation-message" />
                        </div>

                        <div class="form-group full-width">
                            <label for="a-address">Address</label>
                            <InputText id="a-address" class="form-control" @bind-Value="applicantProfile.Address" />
                            <ValidationMessage For="@(() => applicantProfile.Address)" class="validation-message" />
                        </div>
                    </div>

                    <button type="submit" class="submit-btn primary-btn">
                        Create Applicant Account
                    </button>
                </EditForm>
            }
            else if (currentMode == RegisterMode.Representative)
            {
                <EditForm Model="@representativeProfile" OnValidSubmit="HandleRepresentativeSubmit">
                    <DataAnnotationsValidator />

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="r-name">Full Name</label>
                            <InputText id="r-name" class="form-control" @bind-Value="representativeProfile.Name" />
                            <ValidationMessage For="@(() => representativeProfile.Name)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="r-email">Email</label>
                            <InputText id="r-email" class="form-control" @bind-Value="representativeProfile.Email" />
                            <ValidationMessage For="@(() => representativeProfile.Email)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="r-position">Position</label>
                            <InputText id="r-position" class="form-control" @bind-Value="representativeProfile.Position" />
                            <ValidationMessage For="@(() => representativeProfile.Position)" class="validation-message" />
                        </div>

                        <div class="form-group">
                            <label for="r-password">Password</label>
                            <InputText type="password" id="r-password" class="form-control" @bind-Value="representativeProfile.Password" />
                            <ValidationMessage For="@(() => representativeProfile.Password)" class="validation-message" />
                        </div>
                    </div>

                    <button type="submit" class="submit-btn primary-btn">
                        Create Company Account
                    </button>
                </EditForm>
            }

            <div class="@($"notification-container {(notificationVisible ? "show" : "")}")">
                <div class="@($"notification {notificationType}")">
                    @notificationMessage
                </div>
            </div>

            <div class="register-footer-hint">
                Already have an account? <a href="/login">Log in</a>.
            </div>
        </div>
    </div>
</div>

@code {
    private enum RegisterMode
    {
        Applicant,
        Representative
    }

    private RegisterMode currentMode = RegisterMode.Applicant;

    private AddApplicantDto applicantProfile = new();
    private AddCompanyRepresentativeDto representativeProfile = new();

    private bool notificationVisible = false;
    private string notificationMessage = string.Empty;
    private string notificationType = string.Empty;

    private void SetMode(RegisterMode mode)
    {
        currentMode = mode;
        notificationVisible = false;
    }
    private async Task HandleApplicantSubmit()
    {
        try
        {
            var created = await HttpApplicantService.AddApplicantAsync(new AddApplicantDto
            {
                Name      = applicantProfile.Name,
                Email     = applicantProfile.Email,
                Password  = applicantProfile.Password,
                Experience= applicantProfile.Experience,
                City      = applicantProfile.City,
                Postcode  = applicantProfile.Postcode,
                Address   = applicantProfile.Address
            });

            ShowNotification(message: "Applicant account created successfully!", type: "success");

            await Task.Delay(800); // opcjonalne

            
            Nav.NavigateTo($"/applicant/skills/{created.Id}");
        }
        catch
        {
            ShowNotification(message: "Failed to create applicant account. Please try again.", type: "error");
            
        }
    }



    private async Task HandleRepresentativeSubmit()
    {
        try
        {
            await HttpCompanyRepresentativeService.AddCompanyRepresentativeAsync(representativeProfile);
            ShowNotification("Company representative account created successfully!", "success");
        }
        catch
        {
            ShowNotification("Failed to create company representative account. Please try again.", "error");
        }
    }

    private void ShowNotification(string message, string type)
    {
        notificationMessage = message;
        notificationType = type;
        notificationVisible = true;

        _ = Task.Delay(3000).ContinueWith(_ =>
        {
            notificationVisible = false;
            InvokeAsync(StateHasChanged);
        });
    }
}
